local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")

-- PASTIKAN ini sama persis dengan URL server kamu (ngrok / VPS)
-- JANGAN pakai /validate/usn/register, tapi langsung /validate
local API_BASE_URL = "http://151.240.0.25:3001"

local player = Players.LocalPlayer
local playerName = player and player.Name or "Unknown"

-- Function untuk validasi USN
local function validateUsn()
    if not _G.script_key then
        error("[Fyy Loader] _G.script_key belum di-set")
    end
    
    print("[Fyy Loader] Memulai validasi USN untuk player:", playerName)
    print("[Fyy Loader] Key:", _G.script_key)
    
    -- Bangun URL dengan parameter query (sesuai server.js baru)
    local params = {
        key = _G.script_key,
        usn = playerName, -- USN = Roblox username
        robloxId = tostring(player.UserId),
        placeId = tostring(game.PlaceId)
    }
    
    -- Encode parameters untuk URL
    local queryString = ""
    for k, v in pairs(params) do
        queryString = queryString .. (queryString == "" and "?" or "&")
        queryString = queryString .. k .. "=" .. HttpService:UrlEncode(v)
    end
    
    local fullUrl = API_BASE_URL .. "/validate" .. queryString
    
    print("[Fyy Loader] Mengirim request ke:", fullUrl)
    
    -- Kirim request GET ke server
    local success, response = pcall(function()
        return HttpService:GetAsync(fullUrl, false) -- false = non-asynchronous
    end)
    
    if not success then
        warn("[Fyy Loader] ‚ùå Gagal koneksi ke API:", response)
        player:Kick("[Fyy Loader] Gagal menghubungi server validasi.\nCoba lagi nanti atau hubungi admin.")
        return false
    end
    
    -- Parse response JSON
    local ok, data = pcall(function()
        return HttpService:JSONDecode(response)
    end)
    
    if not ok then
        warn("[Fyy Loader] ‚ùå Gagal parse response:", response)
        player:Kick("[Fyy Loader] Server response tidak valid.")
        return false
    end
    
    print("[Fyy Loader] Response:", data.status, data.code)
    
    -- Handle berbagai response code
    if data.status == "ok" then
        -- SUCCESS CASES
        if data.code == "OK" or data.code == "FIRST_BIND" then
            print("[Fyy Loader] ‚úÖ Validasi berhasil!")
            print("[Fyy Loader] Code:", data.code)
            print("[Fyy Loader] Message:", data.message)
            
            -- Jika ada slot info, tampilkan
            if data.data and data.data.slotInfo then
                print("[Fyy Loader] Slot Info:", data.data.slotInfo)
            end
            
            return true
        end
    elseif data.status == "error" then
        -- ERROR CASES
        local errorMsg = data.message or "Unknown error"
        local errorCode = data.code or "UNKNOWN"
        
        print("[Fyy Loader] ‚ùå Validasi gagal:", errorCode, "-", errorMsg)
        
        -- Handle specific error codes
        if errorCode == "USN_MISMATCH" then
            player:Kick("[Fyy Loader] Username ini sudah dipakai di key lain!\nGunakan username berbeda atau minta admin untuk reset.")
        elseif errorCode == "SLOT_FULL" then
            player:Kick("[Fyy Loader] Slot USN penuh! Hubungi admin di Discord untuk tambah slot.")
        elseif errorCode == "EXPIRED" then
            player:Kick("[Fyy Loader] Key sudah expired. Hubungi owner untuk perpanjang.")
        elseif errorCode == "BLACKLISTED" then
            player:Kick("[Fyy Loader] Key diblacklist. Hubungi owner untuk info lebih lanjut.")
        elseif errorCode == "INVALID_KEY" then
            player:Kick("[Fyy Loader] Key tidak valid.\nPastikan sudah redeem key di Discord!")
        elseif errorCode == "NOT_BOUND" then
            player:Kick("[Fyy Loader] Key belum di-redeem. Redeem dulu di Discord server!")
        else
            player:Kick("[Fyy Loader] Error: " .. errorMsg)
        end
        return false
    end
    
    -- Fallback
    warn("[Fyy Loader] Response tidak dikenali:", response)
    player:Kick("[Fyy Loader] Server response tidak dikenali.")
    return false
end

-- Function untuk cek info key (optional, untuk debug)
local function checkKeyInfo()
    if not _G.script_key then return end
    
    local url = API_BASE_URL .. "/key/" .. HttpService:UrlEncode(_G.script_key)
    
    local success, response = pcall(function()
        return HttpService:GetAsync(url, false)
    end)
    
    if success and response then
        local ok, data = pcall(function()
            return HttpService:JSONDecode(response)
        end)
        
        if ok and data.status == "ok" then
            print("[Fyy Loader] üîç Info Key:")
            print("  ‚Ä¢ Key:", data.data.key)
            print("  ‚Ä¢ Role ID:", data.data.roleId or "Default")
            print("  ‚Ä¢ USN Resets:", data.data.usnResets or 0)
            print("  ‚Ä¢ Expired:", data.data.expiresAt or "Permanent")
            print("  ‚Ä¢ Blacklisted:", data.data.blacklisted and "‚úÖ" or "‚ùå")
            print("  ‚Ä¢ Has USN:", data.data.hasUsn and "‚úÖ" or "‚ùå")
            print("  ‚Ä¢ System:", data.data.system or "Unknown")
        end
    end
end

-- Function untuk cek slot info (optional)
local function checkSlotInfo(userId)
    if not userId then return end
    
    local url = API_BASE_URL .. "/slots/" .. tostring(userId)
    
    local success, response = pcall(function()
        return HttpService:GetAsync(url, false)
    end)
    
    if success and response then
        local ok, data = pcall(function()
            return HttpService:JSONDecode(response)
        end)
        
        if ok and data.status == "ok" then
            print("[Fyy Loader] üìä Slot Info:")
            print("  ‚Ä¢ User ID:", data.data.userId)
            print("  ‚Ä¢ Total Slots:", data.data.totalSlots)
            print("  ‚Ä¢ Used Keys:", data.data.usedKeys)
            print("  ‚Ä¢ Available Slots:", data.data.availableSlots)
            print("  ‚Ä¢ Can Add More:", data.data.canAddMore and "‚úÖ" or "‚ùå")
        end
    end
end

-- Main execution
print("[Fyy Loader] ================================")
print("[Fyy Loader] FYY PREMIUM LOADER - USN SYSTEM v2")
print("[Fyy Loader] ================================")

-- Cek apakah script_key ada
if not _G.script_key then
    player:Kick("[Fyy Loader] Script key tidak ditemukan.\nGunakan script dari panel Discord!")
    return
end

-- Optional: Debug info
-- checkKeyInfo()
-- checkSlotInfo(player.UserId)

-- Validasi USN
local isValid = validateUsn()

if not isValid then
    return -- Sudah di-kick di dalam function
end

print("[Fyy Loader] ================================")
print("[Fyy Loader] ‚úÖ Validasi sukses! Memuat script...")
print("[Fyy Loader] ================================")

-- Tunggu sebentar sebelum load script utama
wait(1)

-- Load script utama kamu
local success, err = pcall(function()
    loadstring(game:HttpGet("https://raw.githubusercontent.com/fyywannafly-sudo/FyyCommunity/refs/heads/main/MT_LOADER"))()
end)

if not success then
    warn("[Fyy Loader] Gagal load script utama:", err)
    player:Kick("[Fyy Loader] Gagal load script utama. Coba lagi nanti.")
end
