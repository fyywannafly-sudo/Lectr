-- HTTP Monitor by Roblox Script
-- Features: HTTP Intercept, Request/Response Viewer, Download, GUI Controls

local function formatRawHttp(method, url, headers, body)
    local host, path = "unknown", "/"
    
    if url:find("://") then
        local afterProtocol = url:split("://")[2]
        if afterProtocol then
            local parts = afterProtocol:split("/")
            host = parts[1]
            if #parts > 1 then
                path = "/" .. table.concat({table.unpack(parts, 2)}, "/")
            end
        end
    end
    
    local raw = string.format("%s %s HTTP/1.1\nHost: %s\n", method, path, host)
    
    if headers then
        for k, v in pairs(headers) do
            raw = raw .. k .. ": " .. tostring(v) .. "\n"
        end
    end
    
    if body then
        local bodyStr = tostring(body)
        if #bodyStr > 100000 then
            bodyStr = bodyStr:sub(1, 100000) .. "\n\n... [TRUNCATED BODY]"
        end
        raw = raw .. "Content-Length: " .. #body .. "\n\n" .. bodyStr
    end
    
    return raw
end

local function formatResponse(response, responseHeaders)
    local responseStr = tostring(response)
    
    -- Jika sudah format HTTP, langsung return (dengan truncate jika perlu)
    if responseStr:match("^HTTP/1%.1") and not (responseHeaders and next(responseHeaders)) then
        if #responseStr > 500000 then
            responseStr = responseStr:sub(1, 500000) .. "\n\n... [TRUNCATED: " .. #tostring(response) .. " characters total]"
        end
        return responseStr
    end
    
    -- Format response dengan headers
    local raw = "HTTP/1.1 200 OK\n"
    if responseHeaders then
        for k, v in pairs(responseHeaders) do
            raw = raw .. k .. ": " .. tostring(v) .. "\n"
        end
    end
    
    -- Truncate jika perlu
    if #responseStr > 500000 then
        responseStr = responseStr:sub(1, 500000) .. "\n\n... [TRUNCATED: " .. #tostring(response) .. " characters total]"
    end
    
    return raw .. "\n" .. responseStr
end

local function create(class, props)
    local obj = Instance.new(class)
    for k, v in pairs(props) do
        if k == "Parent" then continue end
        obj[k] = v
    end
    obj.Parent = props.Parent
    return obj
end

-- Logo Mini untuk Toggle GUI
local miniLogo = create("ImageButton", {
    Name = "HttpMonitorLogo",
    Parent = game:GetService("CoreGui"),
    Size = UDim2.new(0, 50, 0, 50),
    Position = UDim2.new(0, 10, 0, 10),
    BackgroundColor3 = Color3.fromRGB(35, 35, 35),
    BorderSizePixel = 0,
    Image = "rbxassetid://7072706620", -- Default Roblox icon, bisa diganti
    ImageColor3 = Color3.fromRGB(100, 150, 255)
})

local logoLabel = create("TextLabel", {
    Size = UDim2.new(1, 0, 0, 15),
    Position = UDim2.new(0, 0, 1, -15),
    BackgroundTransparency = 0.5,
    BackgroundColor3 = Color3.fromRGB(0, 0, 0),
    TextColor3 = Color3.new(1, 1, 1),
    Font = Enum.Font.GothamBold,
    TextSize = 10,
    Text = "HTTP",
    Parent = miniLogo
})

-- Main GUI
local gui = create("ScreenGui", {Name = "HttpMonitor", Parent = game:GetService("CoreGui")})

local main = create("Frame", {
    Size = UDim2.new(0, 1000, 0, 700),
    Position = UDim2.new(0.5, -500, 0.5, -350),
    BackgroundColor3 = Color3.fromRGB(25, 25, 25),
    BorderSizePixel = 0,
    Parent = gui,
    Visible = false  -- Awalnya hidden
})

local header = create("Frame", {
    Size = UDim2.new(1, 0, 0, 40),
    BackgroundColor3 = Color3.fromRGB(35, 35, 35),
    BorderSizePixel = 0,
    Parent = main
})

local title = create("TextLabel", {
    Size = UDim2.new(0.6, 0, 1, 0),
    Position = UDim2.new(0, 15, 0, 0),
    BackgroundTransparency = 1,
    TextColor3 = Color3.new(1, 1, 1),
    Font = Enum.Font.GothamBold,
    TextSize = 18,
    TextXAlignment = Enum.TextXAlignment.Left,
    Text = "ðŸŒ HTTP Monitor",
    Parent = header
})

local statusLabel = create("TextLabel", {
    Size = UDim2.new(0.3, 0, 1, 0),
    Position = UDim2.new(0.65, 0, 0, 0),
    BackgroundTransparency = 1,
    TextColor3 = Color3.fromRGB(200, 200, 100),
    Font = Enum.Font.Gotham,
    TextSize = 12,
    TextXAlignment = Enum.TextXAlignment.Right,
    Text = "Requests: 0 | Intercept: OFF",
    Parent = header
})

local closeBtn = create("TextButton", {
    Size = UDim2.new(0, 30, 0, 30),
    Position = UDim2.new(1, -35, 0.5, -15),
    BackgroundColor3 = Color3.fromRGB(200, 60, 60),
    TextColor3 = Color3.new(1, 1, 1),
    Font = Enum.Font.GothamBold,
    TextSize = 16,
    Text = "Ã—",
    BorderSizePixel = 0,
    Parent = header
})

local minimizeBtn = create("TextButton", {
    Size = UDim2.new(0, 30, 0, 30),
    Position = UDim2.new(1, -70, 0.5, -15),
    BackgroundColor3 = Color3.fromRGB(60, 60, 60),
    TextColor3 = Color3.new(1, 1, 1),
    Font = Enum.Font.GothamBold,
    TextSize = 18,
    Text = "_",
    BorderSizePixel = 0,
    Parent = header
})

local controlPanel = create("Frame", {
    Size = UDim2.new(1, -20, 0, 50),
    Position = UDim2.new(0, 10, 0, 50),
    BackgroundColor3 = Color3.fromRGB(40, 40, 40),
    BorderSizePixel = 0,
    Parent = main
})

local interceptBtn = create("TextButton", {
    Size = UDim2.new(0, 120, 0, 32),
    Position = UDim2.new(0, 10, 0.5, -16),
    BackgroundColor3 = Color3.fromRGB(60, 60, 60),
    TextColor3 = Color3.new(1, 1, 1),
    Font = Enum.Font.GothamBold,
    TextSize = 14,
    Text = "â›” Intercept: OFF",
    BorderSizePixel = 0,
    Parent = controlPanel
})

local clearBtn = create("TextButton", {
    Size = UDim2.new(0, 100, 0, 32),
    Position = UDim2.new(0, 140, 0.5, -16),
    BackgroundColor3 = Color3.fromRGB(60, 60, 60),
    TextColor3 = Color3.new(1, 1, 1),
    Font = Enum.Font.GothamBold,
    TextSize = 14,
    Text = "ðŸ—‘ï¸ Clear All",
    BorderSizePixel = 0,
    Parent = controlPanel
})

local autoScrollBtn = create("TextButton", {
    Size = UDim2.new(0, 130, 0, 32),
    Position = UDim2.new(0, 250, 0.5, -16),
    BackgroundColor3 = Color3.fromRGB(60, 60, 60),
    TextColor3 = Color3.new(1, 1, 1),
    Font = Enum.Font.GothamBold,
    TextSize = 14,
    Text = "ðŸ“œ Auto-Scroll: ON",
    BorderSizePixel = 0,
    Parent = controlPanel
})

local filterBox = create("TextBox", {
    Size = UDim2.new(0, 200, 0, 32),
    Position = UDim2.new(1, -210, 0.5, -16),
    BackgroundColor3 = Color3.fromRGB(50, 50, 50),
    TextColor3 = Color3.new(1, 1, 1),
    Font = Enum.Font.Code,
    TextSize = 14,
    PlaceholderText = "Filter URLs...",
    PlaceholderColor3 = Color3.fromRGB(150, 150, 150),
    ClearTextOnFocus = false,
    BorderSizePixel = 0,
    Parent = controlPanel
})

local listScroll = create("ScrollingFrame", {
    Size = UDim2.new(0, 300, 1, -180),
    Position = UDim2.new(0, 10, 0, 110),
    BackgroundColor3 = Color3.fromRGB(30, 30, 30),
    ScrollBarThickness = 10,
    BorderSizePixel = 0,
    Parent = main
})

local listLayout = create("UIListLayout", {
    SortOrder = Enum.SortOrder.LayoutOrder,
    Padding = UDim.new(0, 5),
    Parent = listScroll
})

local tabContainer = create("Frame", {
    Size = UDim2.new(1, -330, 0, 40),
    Position = UDim2.new(0, 320, 0, 110),
    BackgroundColor3 = Color3.fromRGB(30, 30, 30),
    BorderSizePixel = 0,
    Parent = main
})

local requestTab = create("TextButton", {
    Size = UDim2.new(0.33, -2, 1, 0),
    BackgroundColor3 = Color3.fromRGB(50, 50, 50),
    TextColor3 = Color3.new(1, 1, 1),
    Font = Enum.Font.GothamBold,
    TextSize = 14,
    Text = "ðŸ“¨ Request",
    BorderSizePixel = 0,
    Parent = tabContainer
})

local responseTab = create("TextButton", {
    Size = UDim2.new(0.33, -2, 1, 0),
    Position = UDim2.new(0.33, 2, 0, 0),
    BackgroundColor3 = Color3.fromRGB(40, 40, 40),
    TextColor3 = Color3.new(1, 1, 1),
    Font = Enum.Font.GothamBold,
    TextSize = 14,
    Text = "ðŸ“¤ Response",
    BorderSizePixel = 0,
    Parent = tabContainer
})

local headersTab = create("TextButton", {
    Size = UDim2.new(0.34, -2, 1, 0),
    Position = UDim2.new(0.66, 2, 0, 0),
    BackgroundColor3 = Color3.fromRGB(40, 40, 40),
    TextColor3 = Color3.new(1, 1, 1),
    Font = Enum.Font.GothamBold,
    TextSize = 14,
    Text = "ðŸ“‹ Headers",
    BorderSizePixel = 0,
    Parent = tabContainer
})

local downloadBtn = create("TextButton", {
    Size = UDim2.new(0, 120, 0, 32),
    Position = UDim2.new(1, -125, 0.5, -16),
    BackgroundColor3 = Color3.fromRGB(60, 100, 180),
    TextColor3 = Color3.new(1, 1, 1),
    Font = Enum.Font.GothamBold,
    TextSize = 14,
    Text = "ðŸ’¾ Download",
    BorderSizePixel = 0,
    Visible = false,
    Parent = tabContainer
})

local detailScroll = create("ScrollingFrame", {
    Size = UDim2.new(1, -330, 1, -220),
    Position = UDim2.new(0, 320, 0, 155),
    BackgroundColor3 = Color3.fromRGB(20, 20, 20),
    ScrollBarThickness = 10,
    BorderSizePixel = 0,
    Parent = main
})

local detailText = create("TextBox", {
    Size = UDim2.new(1, -20, 1, -20),
    Position = UDim2.new(0, 10, 0, 10),
    BackgroundTransparency = 1,
    TextColor3 = Color3.new(1, 1, 1),
    Font = Enum.Font.Code,
    TextSize = 13,
    MultiLine = true,
    TextXAlignment = Enum.TextXAlignment.Left,
    TextYAlignment = Enum.TextYAlignment.Top,
    Text = "Select a request to view details",
    ClearTextOnFocus = false,
    TextWrapped = false,
    ClipsDescendants = false,
    Parent = detailScroll
})

local actionBar = create("Frame", {
    Size = UDim2.new(1, -330, 0, 50),
    Position = UDim2.new(0, 320, 1, -60),
    BackgroundColor3 = Color3.fromRGB(30, 30, 30),
    BorderSizePixel = 0,
    Visible = false,
    Parent = main
})

local forwardBtn = create("TextButton", {
    Size = UDim2.new(0, 140, 0, 36),
    Position = UDim2.new(0.5, 10, 0.5, -18),
    BackgroundColor3 = Color3.fromRGB(80, 150, 80),
    TextColor3 = Color3.new(1, 1, 1),
    Font = Enum.Font.GothamBold,
    TextSize = 14,
    Text = "âœ… Forward",
    BorderSizePixel = 0,
    Parent = actionBar
})

local dropBtn = create("TextButton", {
    Size = UDim2.new(0, 140, 0, 36),
    Position = UDim2.new(0.5, -150, 0.5, -18),
    BackgroundColor3 = Color3.fromRGB(150, 80, 80),
    TextColor3 = Color3.new(1, 1, 1),
    Font = Enum.Font.GothamBold,
    TextSize = 14,
    Text = "âŒ Drop",
    BorderSizePixel = 0,
    Parent = actionBar
})

local modifyBtn = create("TextButton", {
    Size = UDim2.new(0, 140, 0, 36),
    Position = UDim2.new(0.5, -290, 0.5, -18),
    BackgroundColor3 = Color3.fromRGB(100, 100, 200),
    TextColor3 = Color3.new(1, 1, 1),
    Font = Enum.Font.GothamBold,
    TextSize = 14,
    Text = "âœï¸ Modify",
    BorderSizePixel = 0,
    Parent = actionBar
})

local footer = create("Frame", {
    Size = UDim2.new(1, 0, 0, 30),
    Position = UDim2.new(0, 0, 1, -30),
    BackgroundColor3 = Color3.fromRGB(35, 35, 35),
    BorderSizePixel = 0,
    Parent = main
})

local footerText = create("TextLabel", {
    Size = UDim2.new(1, -20, 1, 0),
    Position = UDim2.new(0, 10, 0, 0),
    BackgroundTransparency = 1,
    TextColor3 = Color3.fromRGB(180, 180, 180),
    Font = Enum.Font.Code,
    TextSize = 12,
    TextXAlignment = Enum.TextXAlignment.Left,
    Text = "ðŸ”„ Active | Press HOME to toggle | Drag header to move",
    Parent = footer
})

-- State Management
local State = {
    requests = {},
    filteredRequests = {},
    selectedRequest = nil,
    currentTab = "request",
    interceptEnabled = false,
    interceptQueue = {},
    currentIntercept = nil,
    interceptId = 0,
    autoScroll = true,
    filterText = "",
    minimized = false
}

-- Update status label
local function updateStatus()
    local count = #State.requests
    local interceptStatus = State.interceptEnabled and "ON" or "OFF"
    statusLabel.Text = string.format("Requests: %d | Intercept: %s", count, interceptStatus)
end

-- Update detail scroll size
local function updateDetailScroll()
    local lines = string.split(detailText.Text, "\n")
    local maxWidth = 0
    for _, line in ipairs(lines) do 
        maxWidth = math.max(maxWidth, #line) 
    end
    detailScroll.CanvasSize = UDim2.new(0, math.max(maxWidth * 8, detailScroll.AbsoluteSize.X), 0, #lines * 18)
    
    -- Auto scroll to bottom
    if State.autoScroll then
        task.wait()
        detailScroll.CanvasPosition = Vector2.new(0, detailScroll.CanvasSize.Y.Offset)
    end
end

-- Switch between tabs
local function switchTab(tab)
    State.currentTab = tab
    requestTab.BackgroundColor3 = tab == "request" and Color3.fromRGB(60, 60, 60) or Color3.fromRGB(40, 40, 40)
    responseTab.BackgroundColor3 = tab == "response" and Color3.fromRGB(60, 60, 60) or Color3.fromRGB(40, 40, 40)
    headersTab.BackgroundColor3 = tab == "headers" and Color3.fromRGB(60, 60, 60) or Color3.fromRGB(40, 40, 40)
    
    updateDetailView()
end

-- Update detail view based on selected request
local function updateDetailView()
    local source = State.selectedRequest and State.requests[State.selectedRequest.LayoutOrder] or State.currentIntercept
    
    if not source then
        detailText.Text = "Select a request to view details"
        detailText.TextEditable = false
        downloadBtn.Visible = false
        updateDetailScroll()
        return
    end
    
    if State.currentTab == "request" then
        detailText.Text = source.requestRaw or "No request data"
        detailText.TextEditable = false
        downloadBtn.Visible = false
        
    elseif State.currentTab == "response" then
        detailText.Text = source.responseRaw or "No response data"
        detailText.TextEditable = State.currentIntercept and not source.isTooLong
        downloadBtn.Visible = source.responseRaw and source.responseRaw ~= "No response data"
        
    elseif State.currentTab == "headers" then
        -- Extract and format headers
        local headersText = "=== REQUEST HEADERS ===\n"
        if source.requestHeaders then
            for k, v in pairs(source.requestHeaders) do
                headersText = headersText .. k .. ": " .. tostring(v) .. "\n"
            end
        end
        
        headersText = headersText .. "\n=== RESPONSE HEADERS ===\n"
        if source.responseHeaders then
            for k, v in pairs(source.responseHeaders) do
                headersText = headersText .. k .. ": " .. tostring(v) .. "\n"
            end
        end
        
        detailText.Text = headersText
        detailText.TextEditable = false
        downloadBtn.Visible = true
    end
    
    updateDetailScroll()
end

-- Create request button in list
local function createRequestButton(req, index)
    local btn = create("TextButton", {
        Size = UDim2.new(1, -10, 0, 70),
        LayoutOrder = index,
        BackgroundColor3 = Color3.fromRGB(40, 40, 40),
        BorderSizePixel = 0,
        Text = "",
        Parent = listScroll
    })
    
    -- Status indicator
    local statusColor = Color3.fromRGB(100, 100, 100)
    if req.status == "PENDING" then statusColor = Color3.fromRGB(200, 200, 50)
    elseif req.status == "MODIFIED" then statusColor = Color3.fromRGB(50, 150, 200)
    elseif req.status == "DROPPED" then statusColor = Color3.fromRGB(200, 50, 50)
    elseif req.status == "CANCELLED" then statusColor = Color3.fromRGB(150, 150, 150)
    end
    
    local statusDot = create("Frame", {
        Size = UDim2.new(0, 8, 0, 8),
        Position = UDim2.new(0, 5, 0, 5),
        BackgroundColor3 = statusColor,
        BorderSizePixel = 0,
        Parent = btn
    })
    
    -- Method label
    create("TextLabel", {
        Size = UDim2.new(0, 70, 0, 20),
        Position = UDim2.new(0, 15, 0, 5),
        BackgroundTransparency = 1,
        TextColor3 = req.method == "GET" and Color3.fromRGB(100, 200, 255) or 
                     req.method == "POST" and Color3.fromRGB(255, 200, 100) or
                     Color3.fromRGB(200, 100, 200),
        Font = Enum.Font.GothamBold,
        TextSize = 13,
        Text = req.method,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = btn
    })
    
    -- Status text
    if req.status and req.status ~= "COMPLETED" then
        create("TextLabel", {
            Size = UDim2.new(0, 80, 0, 16),
            Position = UDim2.new(1, -85, 0, 5),
            BackgroundTransparency = 1,
            TextColor3 = statusColor,
            Font = Enum.Font.Gotham,
            TextSize = 11,
            Text = "[" .. req.status .. "]",
            TextXAlignment = Enum.TextXAlignment.Right,
            Parent = btn
        })
    end
    
    -- URL (truncated)
    local displayUrl = req.url:gsub("https?://", "")
    if #displayUrl > 50 then
        displayUrl = displayUrl:sub(1, 47) .. "..."
    end
    
    create("TextLabel", {
        Size = UDim2.new(1, -20, 0, 40),
        Position = UDim2.new(0, 10, 0, 25),
        BackgroundTransparency = 1,
        TextColor3 = Color3.fromRGB(220, 220, 220),
        Font = Enum.Font.Code,
        TextSize = 11,
        Text = displayUrl,
        TextXAlignment = Enum.TextXAlignment.Left,
        TextYAlignment = Enum.TextYAlignment.Top,
        TextWrapped = true,
        Parent = btn
    })
    
    -- Time stamp
    create("TextLabel", {
        Size = UDim2.new(1, -20, 0, 12),
        Position = UDim2.new(0, 10, 1, -15),
        BackgroundTransparency = 1,
        TextColor3 = Color3.fromRGB(150, 150, 150),
        Font = Enum.Font.Gotham,
        TextSize = 10,
        Text = req.timestamp or "",
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = btn
    })
    
    -- Click handler
    btn.MouseButton1Click:Connect(function()
        if State.selectedRequest then
            State.selectedRequest.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
        end
        
        btn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
        State.selectedRequest = btn
        
        if req.interceptData and req.interceptData.sessionId == State.interceptId then
            State.currentIntercept = req.interceptData
            actionBar.Visible = true
        else
            State.currentIntercept = nil
            actionBar.Visible = false
        end
        
        updateDetailView()
    end)
    
    return btn
end

-- Filter requests based on text
local function filterRequests()
    State.filterText = filterBox.Text:lower()
    
    -- Clear existing buttons
    for _, child in ipairs(listScroll:GetChildren()) do
        if child:IsA("TextButton") then
            child:Destroy()
        end
    end
    
    -- Add filtered requests
    local visibleCount = 0
    for i, req in ipairs(State.requests) do
        if State.filterText == "" or 
           req.url:lower():find(State.filterText, 1, true) or
           req.method:lower():find(State.filterText, 1, true) or
           (req.status and req.status:lower():find(State.filterText, 1, true)) then
            
            createRequestButton(req, i)
            visibleCount = visibleCount + 1
        end
    end
    
    -- Update list size
    listScroll.CanvasSize = UDim2.new(0, 0, 0, visibleCount * 75)
    updateStatus()
end

-- Add new request
local function addRequest(method, url, requestRaw, responseRaw, isTooLong, status, interceptData, requestHeaders, responseHeaders)
    local req = {
        method = method, 
        url = url, 
        requestRaw = requestRaw, 
        responseRaw = responseRaw, 
        isTooLong = isTooLong or false, 
        status = status or "COMPLETED", 
        interceptData = interceptData,
        requestHeaders = requestHeaders,
        responseHeaders = responseHeaders,
        timestamp = os.date("%H:%M:%S")
    }
    
    table.insert(State.requests, 1, req)
    filterRequests()
    
    -- Auto-select if first request
    if #State.requests == 1 and not State.selectedRequest then
        task.wait(0.1)
        for _, child in ipairs(listScroll:GetChildren()) do
            if child:IsA("TextButton") then
                child.MouseButton1Click:Fire()
                break
            end
        end
    end
end

-- Clear all requests
local function clearAllRequests()
    State.requests = {}
    State.selectedRequest = nil
    State.currentIntercept = nil
    
    for _, child in ipairs(listScroll:GetChildren()) do
        if child:IsA("TextButton") then
            child:Destroy()
        end
    end
    
    detailText.Text = "Select a request to view details"
    actionBar.Visible = false
    downloadBtn.Visible = false
    updateStatus()
end

-- Download function
local function downloadText(text, filename)
    if not text or text == "" then return end
    
    -- Remove illegal characters from filename
    filename = filename:gsub("[^%w%.%-_ ]", "_")
    
    -- Try to save file
    local success = false
    if writefile then
        success = pcall(writefile, filename, text)
        if success then
            footerText.Text = "âœ… Saved to: " .. filename
        end
    end
    
    -- Copy to clipboard as fallback
    if setclipboard then
        setclipboard(text)
        if not success then
            footerText.Text = "ðŸ“‹ Copied to clipboard (" .. #text .. " chars)"
        end
    end
    
    -- Reset footer after 3 seconds
    task.delay(3, function()
        footerText.Text = "ðŸ”„ Active | Press HOME to toggle | Drag header to move"
    end)
end

-- Intercept response handler
local function interceptResponse(method, url, requestRaw, response, responseHeaders, currentSessionId, requestHeaders)
    if not State.interceptEnabled or currentSessionId ~= State.interceptId then
        local responseRaw = formatResponse(response, responseHeaders)
        addRequest(method, url, requestRaw, responseRaw, false, "CANCELLED", nil, requestHeaders, responseHeaders)
        return nil
    end
    
    local responseRaw = formatResponse(response, responseHeaders)
    
    local interceptData = {
        method = method, 
        url = url, 
        requestRaw = requestRaw, 
        responseRaw = responseRaw,
        originalResponse = response, 
        modifiedResponse = nil, 
        dropped = false, 
        callback = nil, 
        isTooLong = false,
        sessionId = currentSessionId,
        requestHeaders = requestHeaders,
        responseHeaders = responseHeaders
    }
    
    addRequest(method, url, requestRaw, responseRaw, false, "PENDING", interceptData, requestHeaders, responseHeaders)
    table.insert(State.interceptQueue, interceptData)
    
    if #State.interceptQueue == 1 then
        State.currentIntercept = interceptData
        State.selectedRequest = nil
        actionBar.Visible = true
        switchTab("response")
    end
    
    local thread = coroutine.running()
    interceptData.callback = function() 
        coroutine.resume(thread) 
    end
    coroutine.yield()
    
    return interceptData
end

-- GUI Event Handlers
miniLogo.MouseButton1Click:Connect(function()
    main.Visible = not main.Visible
    miniLogo.ImageColor3 = main.Visible and Color3.fromRGB(100, 200, 100) or Color3.fromRGB(100, 150, 255)
end)

closeBtn.MouseButton1Click:Connect(function()
    main.Visible = false
    miniLogo.ImageColor3 = Color3.fromRGB(100, 150, 255)
end)

minimizeBtn.MouseButton1Click:Connect(function()
    if State.minimized then
        -- Restore
        main.Size = UDim2.new(0, 1000, 0, 700)
        main.Position = UDim2.new(0.5, -500, 0.5, -350)
        minimizeBtn.Text = "_"
        State.minimized = false
    else
        -- Minimize
        main.Size = UDim2.new(0, 1000, 0, 150)
        main.Position = UDim2.new(0.5, -500, 1, -160)
        minimizeBtn.Text = "â–¡"
        State.minimized = true
    end
end)

interceptBtn.MouseButton1Click:Connect(function()
    State.interceptEnabled = not State.interceptEnabled
    interceptBtn.Text = State.interceptEnabled and "âœ… Intercept: ON" or "â›” Intercept: OFF"
    interceptBtn.BackgroundColor3 = State.interceptEnabled and Color3.fromRGB(80, 150, 80) or Color3.fromRGB(60, 60, 60)
    
    if State.interceptEnabled then
        State.interceptId = State.interceptId + 1
    else
        -- Clear pending intercepts when turned off
        for _, item in ipairs(State.interceptQueue) do
            if item.callback then
                item.callback()
            end
        end
        State.interceptQueue = {}
        State.currentIntercept = nil
        actionBar.Visible = false
    end
    
    updateStatus()
end)

clearBtn.MouseButton1Click:Connect(function()
    clearAllRequests()
end)

autoScrollBtn.MouseButton1Click:Connect(function()
    State.autoScroll = not State.autoScroll
    autoScrollBtn.Text = State.autoScroll and "ðŸ“œ Auto-Scroll: ON" or "ðŸ“œ Auto-Scroll: OFF"
end)

filterBox:GetPropertyChangedSignal("Text"):Connect(function()
    filterRequests()
end)

requestTab.MouseButton1Click:Connect(function()
    switchTab("request")
end)

responseTab.MouseButton1Click:Connect(function()
    switchTab("response")
end)

headersTab.MouseButton1Click:Connect(function()
    switchTab("headers")
end)

downloadBtn.MouseButton1Click:Connect(function()
    if State.currentTab == "response" then
        local source = State.selectedRequest and State.requests[State.selectedRequest.LayoutOrder] or State.currentIntercept
        if source and source.responseRaw then
            local filename = "response_" .. os.time() .. ".txt"
            downloadText(source.responseRaw, filename)
        end
    elseif State.currentTab == "headers" then
        downloadText(detailText.Text, "headers_" .. os.time() .. ".txt")
    end
end)

forwardBtn.MouseButton1Click:Connect(function()
    if not State.currentIntercept then return end
    
    if State.currentTab == "response" and detailText.TextEditable then
        local bodyStart = detailText.Text:find("\n\n")
        local newResponse = bodyStart and detailText.Text:sub(bodyStart + 2) or detailText.Text
        if newResponse ~= tostring(State.currentIntercept.originalResponse) then
            State.currentIntercept.modifiedResponse = newResponse
        end
    end
    
    -- Update request status
    for i, req in ipairs(State.requests) do
        if req.interceptData == State.currentIntercept then
            State.requests[i].status = State.currentIntercept.modifiedResponse and "MODIFIED" or "COMPLETED"
            break
        end
    end
    
    if State.currentIntercept.callback then
        State.currentIntercept.callback()
    end
    
    table.remove(State.interceptQueue, 1)
    
    -- Process next intercept
    if #State.interceptQueue > 0 then
        State.currentIntercept = State.interceptQueue[1]
        updateDetailView()
    else
        State.currentIntercept = nil
        actionBar.Visible = false
    end
    
    filterRequests()
end)

dropBtn.MouseButton1Click:Connect(function()
    if not State.currentIntercept then return end
    
    State.currentIntercept.dropped = true
    
    -- Update request status
    for i, req in ipairs(State.requests) do
        if req.interceptData == State.currentIntercept then
            State.requests[i].status = "DROPPED"
            break
        end
    end
    
    if State.currentIntercept.callback then
        State.currentIntercept.callback()
    end
    
    table.remove(State.interceptQueue, 1)
    
    -- Process next intercept
    if #State.interceptQueue > 0 then
        State.currentIntercept = State.interceptQueue[1]
        updateDetailView()
    else
        State.currentIntercept = nil
        actionBar.Visible = false
    end
    
    filterRequests()
end)

modifyBtn.MouseButton1Click:Connect(function()
    if not State.currentIntercept then return end
    detailText.TextEditable = true
    detailText:CaptureFocus()
end)

-- Dragging functionality
local UIS = game:GetService("UserInputService")
local dragging, dragStart, startPos

header.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = main.Position
    end
end)

UIS.InputChanged:Connect(function(input)
    if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        local delta = input.Position - dragStart
        main.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

UIS.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then 
        dragging = false 
    end
end)

-- Keyboard shortcuts
UIS.InputBegan:Connect(function(input, processed)
    if not processed then
        if input.KeyCode == Enum.KeyCode.Home then
            main.Visible = not main.Visible
            miniLogo.ImageColor3 = main.Visible and Color3.fromRGB(100, 200, 100) or Color3.fromRGB(100, 150, 255)
            
        elseif input.KeyCode == Enum.KeyCode.Escape and main.Visible then
            main.Visible = false
            miniLogo.ImageColor3 = Color3.fromRGB(100, 150, 255)
            
        elseif input.KeyCode == Enum.KeyCode.F1 and main.Visible then
            State.interceptEnabled = not State.interceptEnabled
            interceptBtn.MouseButton1Click:Fire()
        end
    end
end)

-- Initialize
updateStatus()
filterRequests()

-- Hook HTTP functions (simplified version)
print("ðŸ”§ HTTP Monitor Initialized!")
print("ðŸ“± Click the blue icon or press HOME to open")
print("ðŸŽ¯ Press F1 to toggle intercept mode")

-- Note: Untuk hooking functions HTTP yang lengkap,
-- tambahkan kode hooking dari script sebelumnya di sini
-- (HttpGet, HttpPost, RequestAsync, syn.request, dll)

-- Contoh hook sederhana:
local originalHttpGet
originalHttpGet = hookfunction(game.HttpGet, function(self, url, ...)
    local requestRaw = formatRawHttp("GET", url, nil, nil)
    local currentSessionId = State.interceptId
    
    local response = originalHttpGet(self, url, ...)
    
    local interceptData = interceptResponse("GET", url, requestRaw, response, nil, currentSessionId, nil)
    
    if interceptData then
        if interceptData.dropped then
            return ""
        end
        if interceptData.modifiedResponse then
            response = interceptData.modifiedResponse
        end
    end
    
    return response
end)

print("âœ… HTTP Monitor Ready! Blue icon on top-left")
