-- ================================
-- Fyy PREMIUM LOADER v2.0 (FIXED SESSION ERROR)
-- ================================
local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

-- ================================
-- CONFIGURATION
-- ================================
local BASE_URL = "http://151.240.0.25:3002"
local SECRET_ENDPOINT = "/AOJWDOJWAJDASODWAHI021031"
local VALIDATE_URL = BASE_URL .. "/validate"
local SCRIPT_URL = BASE_URL .. SECRET_ENDPOINT

-- SETTINGS
local ENABLE_LOGS = true
local MAX_RETRIES = 3
local RETRY_DELAY = 2

-- ================================
-- UTILITY FUNCTIONS
-- ================================
local function log(...)
    if ENABLE_LOGS then
        print("[Fyy Loader]", ...)
    end
end

local function safeWait(seconds)
    local start = tick()
    while tick() - start < seconds do
        RunService.Heartbeat:Wait()
    end
end

local function getHWID()
    local hwid
    local success = pcall(function()
        hwid = game:GetService("RbxAnalyticsService"):GetClientId()
    end)
    
    if success and hwid and hwid ~= "" then
        return hwid
    end
    
    pcall(function()
        hwid = game:GetService("HttpService"):GenerateGUID(false)
    end)
    
    return hwid or "HWID-" .. tostring(tick())
end

local function secureHttpGet(url)
    for attempt = 1, MAX_RETRIES do
        local success, response = pcall(function()
            return game:HttpGet(url, true)
        end)
        
        if success and response and response ~= "" then
            return response
        end
        
        if attempt < MAX_RETRIES then
            log("ðŸ”„ Retry HTTP (" .. attempt .. "/" .. MAX_RETRIES .. ")")
            safeWait(RETRY_DELAY)
        end
    end
    return nil
end

-- ================================
-- VALIDATE KEY FUNCTION
-- ================================
local function validateKey()
    local player = Players.LocalPlayer
    if not player then 
        log("âŒ Player not found")
        return false 
    end
    
    -- Cek key dari variabel global
    local USER_KEY = _G.script_key or "YOUR_KEY_HERE"
    
    if not USER_KEY or USER_KEY == "" or USER_KEY == "YOUR_KEY_HERE" then
        log("âŒ Key tidak ditemukan")
        log("â„¹ï¸ Set: _G.script_key = 'YOUR_KEY' sebelum execute loader")
        return false
    end

    local hwid = getHWID()
    local robloxId = player.UserId
    local username = player.Name
    local placeId = game.PlaceId
    
    log("ðŸ” Validating key: " .. string.sub(USER_KEY, 1, 8) .. "...")
    
    -- Buat URL validasi
    local url = string.format(
        "%s?key=%s&hwid=%s&robloxId=%s&placeId=%s&username=%s",
        VALIDATE_URL,
        HttpService:UrlEncode(USER_KEY),
        HttpService:UrlEncode(hwid),
        tostring(robloxId),
        tostring(placeId),
        HttpService:UrlEncode(username)
    )

    local response = secureHttpGet(url)
    if not response then
        player:Kick("[Fyy Premium] âŒ Gagal terhubung ke server")
        return false
    end

    local data
    local success = pcall(function()
        data = HttpService:JSONDecode(response)
    end)
    
    if not success or not data then
        player:Kick("[Fyy Premium] âŒ Server response error")
        return false
    end

    if data.status == "ok" then
        -- âœ… SIMPAN DATA UNTUK SCRIPT UTAMA
        _G.script_key = USER_KEY
        _G.fyy_hwid = hwid
        _G.fyy_userid = robloxId
        _G.fyy_username = username
        
        log("âœ… Validation success")
        log("ðŸ“¦ User data stored in _G")
        return true, USER_KEY, hwid, robloxId, username
    else
        local errorCode = data.code or "UNKNOWN"
        local errorMsg = data.message or "Validation failed"
        
        if errorCode == "HWID_MISMATCH" then
            player:Kick("[Fyy Premium] âŒ Device mismatch\nHubungi admin untuk reset HWID")
        elseif errorCode == "BLACKLISTED" then
            player:Kick("[Fyy Premium] âŒ Key diblacklist\nHubungi owner")
        elseif errorCode == "EXPIRED" then
            player:Kick("[Fyy Premium] âŒ Key sudah expired")
        else
            player:Kick("[Fyy Premium] âŒ " .. errorMsg)
        end
        return false
    end
end

-- ================================
-- EXTRACT DATA FROM ENCRYPTED LOADER
-- ================================
local function extractLoaderData(loaderCode)
    local data = {}
    
    -- Extract session ID
    data.sessionId = loaderCode:match("Session:%s*(%S+)")
    
    -- Extract encrypted payload
    data.encryptedPayload = loaderCode:match('local ENCRYPTED_PAYLOAD = "([^"]+)"')
    data.ivHex = loaderCode:match('local IV_HEX = "([^"]+)"')
    data.tagHex = loaderCode:match('local TAG_HEX = "([^"]+)"')
    data.keyHint = loaderCode:match('local KEY_HINT = "([^"]+)"')
    
    -- Check if all required data exists
    data.isValid = data.sessionId and 
                   data.encryptedPayload and 
                   data.ivHex and 
                   data.tagHex
    
    return data
end

-- ================================
-- GET SESSION KEY FROM SERVER (FIXED!)
-- ================================
local function getSessionKey(sessionId, userId, hwid)
    if not sessionId or not userId or not hwid then
        log("âŒ Missing parameters for session")
        return nil
    end
    
    -- âœ… FIX: TAMBAHKAN userId DAN hwid SEBAGAI QUERY PARAMETERS
    local sessionUrl = string.format(
        "%s/session/%s?userId=%s&hwid=%s",
        BASE_URL,
        sessionId,
        tostring(userId),
        HttpService:UrlEncode(hwid)
    )
    
    log("ðŸ”‘ Requesting session key...")
    log("URL:", string.sub(sessionUrl, 1, 100) .. "...")
    
    local response = secureHttpGet(sessionUrl)
    if not response then
        log("âŒ No response from session endpoint")
        return nil
    end
    
    -- Parse JSON response
    local sessionData
    local success, err = pcall(function()
        sessionData = HttpService:JSONDecode(response)
    end)
    
    if not success then
        log("âŒ Failed to parse session response:", err)
        log("Raw response:", string.sub(response, 1, 200))
        return nil
    end
    
    if sessionData.error then
        log("âŒ Session error:", sessionData.error)
        if sessionData.hint then
            log("ðŸ’¡ Hint:", sessionData.hint)
        end
        return nil
    end
    
    if not sessionData.key then
        log("âŒ No key in session response")
        return nil
    end
    
    log("âœ… Session key received")
    if sessionData.expiresIn then
        log("â³ Expires in:", math.floor(sessionData.expiresIn / 1000), "seconds")
    end
    
    return sessionData.key
end

-- ================================
-- SIMPLE DECRYPTION (PLACEHOLDER)
-- ================================
local function simpleDecrypt(encryptedHex, keyHex, ivHex, tagHex)
    -- Placeholder function - in real implementation you need AES library
    log("âš ï¸ Using simple XOR decryption (placeholder)")
    
    -- Convert hex to bytes
    local function hexToBytes(hex)
        local bytes = {}
        for i = 1, #hex, 2 do
            local byteStr = hex:sub(i, i+1)
            local byte = tonumber(byteStr, 16)
            if byte then
                table.insert(bytes, byte)
            end
        end
        if #bytes == 0 then return "" end
        return string.char(table.unpack(bytes))
    end
    
    local encrypted = hexToBytes(encryptedHex)
    local key = hexToBytes(keyHex)
    
    if #encrypted == 0 or #key == 0 then
        log("âŒ Invalid hex data")
        return nil
    end
    
    -- Simple XOR "decryption" (for testing only)
    local decrypted = ""
    for i = 1, #encrypted do
        local charCode = string.byte(encrypted, i)
        local keyChar = string.byte(key, (i % #key) + 1)
        if charCode and keyChar then
            decrypted = decrypted .. string.char(bit32.bxor(charCode, keyChar))
        end
    end
    
    return decrypted
end

-- ================================
-- EXECUTE ENCRYPTED LOADER (FIXED!)
-- ================================
local function executeEncryptedLoader(loaderCode, userId, hwid)
    -- Extract data dari loader
    local loaderData = extractLoaderData(loaderCode)
    
    if not loaderData.isValid then
        log("âŒ Invalid loader format")
        log("Has sessionId:", loaderData.sessionId ~= nil)
        log("Has payload:", loaderData.encryptedPayload ~= nil)
        return false
    end
    
    log("ðŸ” Session ID:", string.sub(loaderData.sessionId, 1, 16) .. "...")
    log("ðŸ“¦ Payload size:", #(loaderData.encryptedPayload or ""))
    
    -- Get session key dari server
    local sessionKey = getSessionKey(loaderData.sessionId, userId, hwid)
    if not sessionKey then
        log("âŒ Failed to get session key")
        return false
    end
    
    -- Decrypt script
    log("ðŸ”“ Decrypting script...")
    local decrypted = simpleDecrypt(
        loaderData.encryptedPayload,
        sessionKey,
        loaderData.ivHex,
        loaderData.tagHex
    )
    
    if not decrypted or #decrypted < 100 then
        log("âš ï¸ Decryption failed or result too short")
        log("ðŸ“„ Decrypted preview:", string.sub(decrypted or "", 1, 200))
        
        -- Fallback: try to execute loader directly
        log("ðŸ”„ Trying fallback execution...")
        local fn, err = loadstring(loaderCode)
        if fn then
            local success, err2 = pcall(fn)
            if success then
                log("âœ… Loader executed (fallback mode)")
                return true
            else
                log("âŒ Fallback execution failed:", err2)
            end
        else
            log("âŒ Failed to load loader:", err)
        end
        return false
    end
    
    -- Execute decrypted script
    log("âœ… Decryption successful (" .. #decrypted .. " bytes)")
    log("ðŸš€ Executing decrypted script...")
    
    local fn, err = loadstring(decrypted)
    if fn then
        local success, err2 = pcall(fn)
        if success then
            log("ðŸŽ‰ Script executed successfully")
            return true
        else
            log("âŒ Script execution error:", err2)
            return false
        end
    else
        log("âŒ Failed to load decrypted script:", err)
        return false
    end
end

-- ================================
-- DOWNLOAD ENCRYPTED SCRIPT
-- ================================
local function downloadEncryptedScript(userKey, hwid, robloxId, username)
    if not userKey then 
        log("âŒ No user key provided")
        return nil 
    end
    
    local url = string.format(
        "%s?key=%s&hwid=%s&robloxId=%s&username=%s",
        SCRIPT_URL,
        HttpService:UrlEncode(userKey),
        HttpService:UrlEncode(hwid),
        tostring(robloxId),
        HttpService:UrlEncode(username)
    )
    
    log("ðŸ“¥ Downloading encrypted script...")
    log("URL:", string.sub(url, 1, 80) .. "...")
    
    local response = secureHttpGet(url)
    if not response then
        log("âŒ Failed to download script")
        return nil
    end
    
    -- Check for error messages
    if string.find(response, "ERROR:") or 
       string.find(response, "ACCESS DENIED") or
       string.find(response, "KEY BLACKLISTED") then
        
        log("âŒ Server returned error")
        
        -- Try to extract error message
        local errorLine = response:match("ERROR:%s*(.-)\n") or 
                         response:match("--%s*ERROR:%s*(.-)\n") or
                         "Unknown error"
        
        game:GetService("Players").LocalPlayer:Kick("[Fyy Premium] âŒ " .. errorLine)
        return nil
    end
    
    log("âœ… Encrypted loader received (" .. #response .. " bytes)")
    return response
end

-- ================================
-- MAIN EXECUTION
-- ================================
local function main()
    -- Tunggu game ready
    safeWait(2)
    
    -- Validasi key
    local valid, userKey, hwid, robloxId, username = validateKey()
    if not valid then
        log("âŒ Key validation failed")
        return
    end
    
    log("ðŸ‘¤ User:", username, "(ID:", robloxId, ")")
    log("ðŸ”‘ Key:", string.sub(userKey, 1, 8) .. "...")
    log("ðŸ–¥ï¸ HWID:", string.sub(hwid, 1, 8) .. "...")
    
    -- Download encrypted script
    local loaderCode = downloadEncryptedScript(userKey, hwid, robloxId, username)
    if not loaderCode then
        log("âŒ Failed to download script")
        return
    end
    
    -- Check if this is an encrypted loader or regular script
    local loaderData = extractLoaderData(loaderCode)
    
    if loaderData.isValid then
        -- This is an encrypted loader, need to decrypt
        log("ðŸ” Detected encrypted loader, processing...")
        local success = executeEncryptedLoader(loaderCode, tostring(robloxId), hwid)
        
        if success then
            log("ðŸŽ‰ Premium features loaded (encrypted)")
        else
            log("âš ï¸ Encrypted loader execution failed")
            
            -- Last resort: try to execute as regular script
            log("ðŸ”„ Trying as regular script...")
            local fn, err = loadstring(loaderCode)
            if fn then
                pcall(fn)
                log("âœ… Executed as regular script")
            end
        end
    else
        -- This is a regular script, execute directly
        log("ðŸ“œ Detected regular script, executing...")
        local fn, err = loadstring(loaderCode)
        if fn then
            pcall(fn)
            log("âœ… Regular script executed")
        else
            log("âŒ Failed to load script:", err)
        end
    end
    
    -- Background re-validation
    spawn(function()
        while true do
            safeWait(300)
            if not validateKey() then
                log("âš ï¸ Re-validation failed")
                break
            end
        end
    end)
end

-- ================================
-- INITIALIZE
-- ================================
spawn(function()
    safeWait(3) -- Tunggu 3 detik sebelum mulai
    
    -- Check if key is set
    if not _G.script_key or _G.script_key == "" then
        log("â„¹ï¸ No key provided - script won't run")
        log("ðŸ’¡ Set key with: _G.script_key = 'YOUR_KEY'")
        return
    end
    
    log("ðŸš€ Starting Fyy Premium Loader...")
    main()
end)

-- Export untuk debugging
return {
    validateKey = validateKey,
    getHWID = getHWID,
    version = "2.2-fixed",
    description = "Fixed session parameter error"
}
