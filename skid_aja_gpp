local HttpService = game:GetService("HttpService")

local BASE_URL = "http://151.240.0.25:3000"
local VALIDATE_URL = BASE_URL .. "/validate"
local SCRIPT_URL = BASE_URL .. "/script"
local SECRET_HEADER = "FYY-20-05-2222ASD" -- HARUS SAMA DENGAN DI SERVER.JS

local function validateKey()
    if not _G.script_key then
        error("[Fyy Loader] _G.script_key belum di-set")
    end

    local hwid = game:GetService("RbxAnalyticsService"):GetClientId()
    local player = game.Players.LocalPlayer
    local robloxId = player and player.UserId or 0
    local placeId = game.PlaceId

    local url = string.format(
        "%s?key=%s&hwid=%s&robloxId=%s&placeId=%s",
        VALIDATE_URL,
        HttpService:UrlEncode(_G.script_key),
        HttpService:UrlEncode(hwid),
        tostring(robloxId),
        tostring(placeId)
    )

    local ok, response = pcall(function()
        return game:HttpGet(url, true)
    end)

    if not ok or not response or response == "" then
        if player then
            player:Kick("[Fyy Loader] ‚ùå Server offline / timeout.")
        end
        return false
    end

    local data
    ok, _ = pcall(function()
        data = HttpService:JSONDecode(response)
    end)

    if not ok or not data then
        warn("[Fyy Loader] Response tidak valid:", response)
        if player then
            player:Kick("[Fyy Loader] ‚ùå Server response error.")
        end
        return false
    end

    if data.status ~= "ok" then
        if player then
            player:Kick("[Fyy Loader] ‚ùå " .. (data.message or "Key invalid"))
        end
        return false
    end

    print("[Fyy Loader] ‚úÖ Validation OK:", data.code, data.message)
    return true
end

-- ================================
-- DOWNLOAD SCRIPT DENGAN HEADERS
-- ================================
local function downloadScript()
    local hwid = game:GetService("RbxAnalyticsService"):GetClientId()
    
    -- Headers khusus untuk security
    local headers = {
        ["X-Request-Source"] = SECRET_HEADER,
        ["X-Auth-Token"] = hwid,
        ["X-Client-Time"] = tostring(tick())
    }
    
    local url = string.format(
        "%s?key=%s&hwid=%s",
        SCRIPT_URL,
        HttpService:UrlEncode(_G.script_key),
        HttpService:UrlEncode(hwid)
    )
    
    local success, response = pcall(function()
        return game:HttpGet(url, true, headers)
    end)
    
    return success, response
end

-- ================================
-- MAIN EXECUTION
-- ================================
local isValid = validateKey()
if not isValid then
    return
end

print("[Fyy Loader] üöÄ Script premium mulai jalan untuk key:", _G.script_key)

-- Download script dengan headers
local success, scriptContent = downloadScript()

if not success or not scriptContent then
    local player = game.Players.LocalPlayer
    if player then
        player:Kick("[Fyy Loader] ‚ùå Gagal download script.")
    end
    return
end

-- Execute script
local success, errorMsg = pcall(function()
    loadstring(scriptContent)()
end)

if not success then
    warn("[Fyy Loader] ‚ùå Error execute script:", errorMsg)
end
