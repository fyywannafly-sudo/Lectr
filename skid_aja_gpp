local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")

local function kick(msg)
    local player = Players.LocalPlayer
    if player then 
        player:Kick(msg)
    end
    return false
end

local function validateAndLoad()
    -- CEK APAKAH _G.script_key ADA DAN VALID
    if not _G.script_key then
        return kick("❌ Script key not set. Please set _G.script_key = 'YOUR_KEY'")
    end
    
    -- CEK FORMAT KEY (minimal 8 karakter)
    if type(_G.script_key) ~= "string" or #_G.script_key < 8 then
        return kick("❌ Invalid key format. Key must be at least 8 characters")
    end
    
    local hwid = game:GetService("RbxAnalyticsService"):GetClientId()
    local base = "http://151.240.0.25:3000"
    
    -- Validate
    local url = base .. "/validate?key=" .. HttpService:UrlEncode(_G.script_key) .. "&hwid=" .. HttpService:UrlEncode(hwid)
    local ok, res = pcall(game.HttpGet, game, url, true)
    
    if not ok or not res then
        return kick("❌ Server error - Cannot connect to validation server")
    end
    
    local data = pcall(HttpService.JSONDecode, HttpService, res)
    if not data or data.status ~= "ok" then
        return kick("❌ Invalid or expired key")
    end
    
    -- Download
    url = base .. "/script?key=" .. HttpService:UrlEncode(_G.script_key) .. "&hwid=" .. HttpService:UrlEncode(hwid)
    ok, res = pcall(game.HttpGet, game, url, true)
    
    if not ok or not res then
        return kick("❌ Failed to download script")
    end
    
    -- Execute
    ok, err = pcall(loadstring, res)
    if not ok then
        return kick("❌ Script error: " .. tostring(err):sub(1, 100))
    end
    
    return true
end

-- ================================
-- START EXECUTION WITH ERROR HANDLING
-- ================================
local success, errorMsg = pcall(validateAndLoad)
if not success then
    kick("❌ Loader error: " .. tostring(errorMsg))
end
