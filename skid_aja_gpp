local HttpService = game:GetService("HttpService")

-- BASE URL SAMA UNTUK SEMUA
local BASE_URL = "http://151.240.0.25:3000"
local VALIDATE_URL = BASE_URL .. "/validate"
local SCRIPT_URL = BASE_URL .. "/script"  -- SAMA SERVER!

local function validateKey()
    if not _G.script_key then
        error("[Fyy Loader] _G.script_key belum di-set")
    end

    local hwid = game:GetService("RbxAnalyticsService"):GetClientId()
    local player = game.Players.LocalPlayer
    local robloxId = player and player.UserId or 0
    local placeId = game.PlaceId

    -- Buat URL validasi
    local url = string.format(
        "%s?key=%s&hwid=%s&robloxId=%s&placeId=%s",
        VALIDATE_URL,
        HttpService:UrlEncode(_G.script_key),
        HttpService:UrlEncode(hwid),
        tostring(robloxId),
        tostring(placeId)
    )

    -- Kirim request ke server validasi
    local ok, response = pcall(function()
        return game:HttpGet(url, true)  -- Async lebih aman
    end)

    -- Cek koneksi gagal
    if not ok or not response or response == "" then
        if player then
            player:Kick("[Fyy Loader] ‚ùå Server offline / timeout.")
        end
        return false
    end

    -- Decode JSON response
    local data
    ok, _ = pcall(function()
        data = HttpService:JSONDecode(response)
    end)

    if not ok or not data then
        warn("[Fyy Loader] Response tidak valid:", response)
        if player then
            player:Kick("[Fyy Loader] ‚ùå Server response error.")
        end
        return false
    end

    -- Cek status response
    if data.status ~= "ok" then
        if player then
            player:Kick("[Fyy Loader] ‚ùå " .. (data.message or "Key invalid"))
        end
        return false
    end

    print("[Fyy Loader] ‚úÖ Validation OK:", data.code, data.message)
    return true
end

-- ================================
-- MAIN EXECUTION
-- ================================

-- 1. Validasi key dulu
local isValid = validateKey()
if not isValid then
    return  -- Stop kalo key invalid
end

print("[Fyy Loader] üöÄ Script premium mulai jalan untuk key:", _G.script_key)

-- 2. Download dan execute script dari SERVER DENGAN KEY
local success, scriptContent = pcall(function()
    -- ‚ö†Ô∏è PERUBAHAN DISINI: TAMBAH PARAMETER key= DI URL
    local downloadUrl = SCRIPT_URL .. "?key=" .. HttpService:UrlEncode(_G.script_key)
    
    -- Optional: Tambah HWID juga untuk extra security
    local hwid = game:GetService("RbxAnalyticsService"):GetClientId()
    downloadUrl = downloadUrl .. "&hwid=" .. HttpService:UrlEncode(hwid)
    
    print("[Fyy Loader] üì• Download script dari:", downloadUrl)
    return game:HttpGet(downloadUrl, true)
end)

if not success or not scriptContent then
    local player = game.Players.LocalPlayer
    if player then
        -- Cek error message untuk debugging
        local errorMsg = scriptContent or "Unknown error"
        
        if errorMsg:find("403") or errorMsg:find("Forbidden") then
            player:Kick("[Fyy Loader] ‚ùå Akses ditolak. Key tidak valid atau expired.")
        elseif errorMsg:find("404") then
            player:Kick("[Fyy Loader] ‚ùå Script tidak ditemukan di server.")
        else
            player:Kick("[Fyy Loader] ‚ùå Gagal download script: " .. errorMsg:sub(1, 100))
        end
    end
    return
end

-- 3. Execute script utama
print("[Fyy Loader] ‚úÖ Script berhasil didownload, executing...")

local success, errorMsg = pcall(function()
    loadstring(scriptContent)()
end)

if not success then
    warn("[Fyy Loader] ‚ùå Error execute script:", errorMsg)
    
    -- Optional: Report error ke server untuk debugging
    local player = game.Players.LocalPlayer
    if player then
        player:Kick("[Fyy Loader] ‚ùå Error load script. Silakan coba lagi.")
    end
else
    print("[Fyy Loader] ‚úÖ Script berhasil dijalankan!")
end
